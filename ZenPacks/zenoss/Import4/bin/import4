#!/usr/bin/env python
##############################################################################
#
# Copyright (C) Zenoss, Inc. 2014-2015, all rights reserved.
#
# This content is made available according to terms specified in
# License.zenoss under the directory where your Zenoss product is installed.
#
##############################################################################

import argparse
import sys
import traceback

from ZenPacks.zenoss.Import4 import migration, model, events, perf
from ZenPacks.zenoss.Import4.migration import Config

exitCode = {
    # model module mapping
    model.Results.COMMAND_ERROR: 14,
    model.Results.UNTAR_FAIL: 13,
    model.Results.INVALID: 12,

    model.Results.FAILURE: 2,
    model.Results.WARNING: 1,
    model.Results.SUCCESS: 0,

    # perf module mapping
    perf.Results.COMMAND_ERROR: 11,
    perf.Results.UNTAR_FAIL: 10,
    perf.Results.INVALID: 9,

    perf.Results.FAILURE: 2,
    perf.Results.WARNING: 1,
    perf.Results.SUCCESS: 0,

    # event module mapping
    events.Results.COMMAND_ERROR: 8,
    events.Results.UNTAR_FAIL: 7,
    events.Results.INVALID: 6,

    events.Results.FAILURE: 2,
    events.Results.WARNING: 1,
    events.Results.SUCCESS: 0,

    # migration module mapping
    migration.Results.FAILURE: 2,
    migration.Results.WARNING: 1,
    migration.Results.SUCCESS: 0,

    None: -1    # when the method has not been implemented
}


def run_migration(migration_class, args):
    # The main control running a migration process
    _migration = migration_class(args, progress_report_callback)

    try:
        {
            'check' : _migration.prevalidate,
            'verify': _migration.postvalidate,
            'import': _migration.importFunc
        }[args.pname]() # Run it

    except migration.ImportError as err:
        sys.stderr.write('Error: %s(%d)\n' % (err.error_string, err.return_code))
        _rc = exitCode[err.error_string]
        if _rc >= exitCode[migration.Results.FAILURE]:
            exit(_rc)
        elif (_rc == exitCode[migration.Results.WARNING]) and (not args.ignorewarnings):
            exit(_rc)
            # else, we continue
        else:
            exit(_rc)
    except Exception as e:
        # unrecognized exception
        print "Huh? unknown exception during import ---", e
        traceback.print_exc(file=sys.stderr)
        exit(-1)

    # all finished successfully
    exit(exitCode[migration.Results.SUCCESS])


def progress_report_callback(msg):
    sys.stdout.write(msg)


def parse_args():
    parser = argparse.ArgumentParser(
        description=(
            "Import data from a 4.x Zenoss instance. These imports are destructive - "
            "the relevant datastores on this instance will be destroyed, and the 4.x "
            "data imported in its place.\n\n"
        )
    )
    # add the global options
    migration.MigrationBase.init_command_parser(parser)

    subparsers = parser.add_subparsers(help='Group of migration functions')
    for module in (model, events, perf):
        m_name = module.__name__.split(".")[-1]
        m_parser = subparsers.add_parser(m_name, description='Tool to migrate %s data' % m_name)
        m_subparser = m_parser.add_subparsers()
        # Add action-specific parsers
        check_parser = m_subparser.add_parser('check', description='Run pre-validation on 4x backup artifact prior to import')
        check_parser.set_defaults(pname='check')
        import_parser = m_subparser.add_parser('import', description='Perform an import')
        import_parser.set_defaults(pname='import')
        verify_parser = m_subparser.add_parser('verify', description='Run post-validation on new system')
        verify_parser.set_defaults(pname='verify')
        module.Migration.init_command_parser(m_parser)
        module.Migration.init_command_parsers(check_parser, verify_parser, import_parser)
        m_parser.set_defaults(functor=lambda args, mclass=module.Migration: run_migration(mclass, args))

    args = parser.parse_args()

    return args


def main():
    args = parse_args()
    args.functor(args)

if __name__ == "__main__":
    main()
